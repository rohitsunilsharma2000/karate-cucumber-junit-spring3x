<!DOCTYPE html>
<html lang="">
<head>
    <title>Private Messaging</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #chatBox {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 15px;
            background-color: #f9f9f9;
        }

        input, button {
            margin: 5px;
        }

        .message {
            margin: 4px 0;
        }
    </style>
</head>
<body>
<h2>Private Messaging</h2>

<div>
    <label for="receiverId">Receiver ID:</label>
    <input id="receiverId" placeholder="Enter Receiver ID" required type="text"/>

    <label for="messageInput"></label><input id="messageInput" placeholder="Type your message..." required type="text"/>
    <button onclick="sendMessage()">Send</button>
</div>

<div id="chatBox"></div>

<script type="text/javascript">
    let stompClient = null;

    // âœ… Injecting Thymeleaf variable
<!--    const userId = /*[[${userId}]]*/ 0;-->
    const userId = [[${userId}]];  // No comment-style wrapping!


    function connectWebSocket() {
        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            stompClient.subscribe('/topic/messages/' + userId, (messageOutput) => {
                const msg = JSON.parse(messageOutput.body);
                showMessage(msg.sender.username, msg.content);
            });
        });
    }

    function showMessage(sender, content) {
        const chatBox = document.getElementById("chatBox");
        const messageElem = document.createElement("p");
        messageElem.classList.add("message");
        messageElem.innerHTML = `<strong>${sender}:</strong> ${content}`;
        chatBox.appendChild(messageElem);
        chatBox.scrollTop = chatBox.scrollHeight; // auto-scroll
    }

    function sendMessage() {
        const receiverId = document.getElementById("receiverId").value.trim();
        const content = document.getElementById("messageInput").value.trim();

        if (!receiverId || !content) {
            alert("Please enter both receiver ID and message");
            return;
        }

        stompClient.send("/app/chat.send", {}, JSON.stringify({
            senderId: userId,
            receiverId: receiverId,
            content: content
        }));

        showMessage("You", content); // Display message locally
        document.getElementById("messageInput").value = '';
    }

    function loadChatHistory(receiverId) {
        fetch(`/api/messages/history?senderId=${userId}&receiverId=${receiverId}`)
            .then(response => response.json())
            .then(messages => {
                document.getElementById("chatBox").innerHTML = '';
                messages.forEach(msg => {
                    showMessage(msg.sender.username, msg.content);
                });
            });
    }

    // Load chat history when receiver ID is entered
    document.getElementById("receiverId").addEventListener("blur", function () {
        const receiverId = this.value.trim();
        if (receiverId) {
            loadChatHistory(receiverId);
        }
    });

    connectWebSocket();
</script>
</body>
</html>
